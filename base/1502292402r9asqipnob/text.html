<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:5px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:34px; background-color:#ffffff;"><span style=" font-family:'Fira Sans,sans-serif'; font-size:xx-large; font-weight:496; color:#444444;">Использование 7zip для бэкапа данных</span></p>
<p style=" margin-top:0px; margin-bottom:16px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/hub/sys_admin/"><span style=" font-family:'Verdana,sans-serif'; font-size:11px; color:#999999; background-color:transparent; vertical-align:middle;">Системное администрирование</span></a><span style=" font-family:'Verdana,sans-serif'; font-size:11px; color:#999999;">*</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:-5px; margin-right:-5px; -qt-block-indent:0; text-indent:0px; line-height:22.4px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;">Для наступления полного и тотального счастья в плане бэкапов информации на рабочем сервере решил отказаться от Acronis True Image в пользу обычной архивации данных с помощью 7-Zip.<br /><br />Для выполнения поставленной задачи естественно использовал консольную версию архиватора.<br /></span><a name="habracut"></a><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br />После непродолжительного курения манов комманда приняла следующий вид:<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000;">7za.exe a -tzip -ssw -mx7 -r0 -x@exclusions.txt full_path_for_the_archive working_dir</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br /><br />Поподробней об использованных ключах:<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">-tzip</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> формат архива установлен в zip, без этого ключа умолчальный формат 7z;<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">-ssw</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> принудительная упаковка файлов, которые в данный момент открыты для записи (мало ли кто-то засиделся на работе и что-то там правит);<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">-mx7</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> высокая степень сжатия (7), можно поставить и 5 (нормальное сжатие), тогда процесс пойдет побыстрее;<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">-r0</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> (это ноль, а не буква О) исключения, которые будут прописаны дальше обрабатываются только в рабочем каталоге;<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">-x@exclusions.txt</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> это собственно говоря файл со списком исключений, которые не будем архивировать. Каждая строка файла — новое исключение. Можно использовать маски типа *.ext и т.п. Если исключение не много, то можно обойтись и без файла, в таком случае ключ примет следующий вид: -x!*.ext;<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">full_path_for_the_archive</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> это соответственно путь и имя нового архива;<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">working_dir</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> это папка, которая подлежит упаковке.<br /><br />Для пущего удобства можно использовать в имени архива </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">%date%</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;">.<br /><br />В связи с тем, что архивировать нужно разные папки в разные архивы, объемами 10-15 гигов, то резонно использовать последовательность команд, дабы не создавать кучу правил в планировщике и не думать сколько времени займет весь этот процесс. Соответственно для этих целей использую объединение команд с помощью </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000;">&amp;&amp;</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;">. Если использовать </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000;">&amp;</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;">, то все команды будут выполняться одновременно, что меня никак не устраивает, с </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000;">&amp;&amp;</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> — последовательно при удачном завершении предыдущей команды.<br /><br />Помимо всего прочего желательно иметь логи, чтоб быть в курсе, а не случилось ли чего. Это можно легко реализовать с помощью инструкции '&gt;&gt;', которая сохраняет вывод в консоль в текстовый файл. Однако проблема в том, что 7zip вываливает в консоль кучу информации, в том числе и об архивации каждого нового файла. Очевидно, что на объемах в несколько тысяч файлов вся эта инфа в логах нужна как мертвому припарок. Соответственно требуется исключить все ненужные строки, оставив те, где есть информация о названии создаваемого архива, результат архивации и информацию об ошибках, коли таковые появятся.<br /><br />Тут на помощь приходит команда </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000;">FINDSTR</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;">. В моем случае она принимает следующий вид:<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000;">findstr /P /I /V «Compressing 7-Zip»</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br /><br />Сначала пара слов об использованных ключах:<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">/P</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> пропускает строки, содержащие непечатные символы;<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">/I</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> на всякий случай игнорирую регистр букв;<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">/V &quot; &quot;</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"> непосредственно перечень слов для поиска в строках и последующего исключения этих строк.<br /><br />В итоге на выходе этой команды имеем 3 строки:<br /><br />Scanning<br /><br />Creating archive </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-style:italic; color:#000000;">archive_name</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br /><br />Everything is Ok<br /><br />А потом закатываю все в текстовый файл, для последующего изучения:<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000;">findstr /P /I /V «Compressing 7-Zip» &gt;&gt; log_file </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br /><br />Теперь дело за малым. Нужно зафутболить все три блока в одну последовательность команд:<br /><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000;">7za.exe a -tzip -ssw -mx7 -r0 -x@exclusions.txt full_path_for_the_archive working_dir | findstr /P /I /V «Compressing 7-Zip» &gt;&gt; log_file.%date%.txt</span></p></body></html>