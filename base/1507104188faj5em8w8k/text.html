<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:28px; background-color:#ffffff;"><span style=" font-family:'Fira Sans,sans-serif'; font-size:8.25pt; font-weight:496; color:#222222; background-color:#ffffff;">Oracle</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">Наконец-то мы добрались до Oracle! Об этой СУБД я хотел бы рассказать поподробнее. В Oracle иерархические запросы появились в 8-ой версии, задолго до появления стандарта. Поэтому до сих пор используется совсем другой синтаксис. Лично мне он кажется более понятным и напоминающим обычные функциональные языки. Хотя, скорее всего, это дело привычки. Описание синтаксиса в документации напоминает бусы: на единую нить запроса нанизываются нужные операторы. Никому не приходило в голову сделать украшение для гички? </span><img src="image5509.png" /><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;"> Тут видно, что единственно важное условие для построения иерархического запроса – это оператор </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">CONNECT BY</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">, остальное “нанизывается” по мере надобности.  Необязательный оператор </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">START WITH</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;"> говорит Ораклу с чего начинать цикл, т.е. какая строка (или строки) будет корневой. Условие может быть практически любым, можно даже использовать функции или внутренние запросы: pid is null, или id = 1, или даже substr(title, 1, 1) = ‘Р’. Условие после CONNECT BY нужно указать обязательно. Тут надо сказать Ораклу, как долго продолжать цикл. Что-то в духе while в обычных языках программирования. Например, мы можем попросить достать нам 10 строк: rownum&lt;=10 – он и нафигачит нам в цикле ровно 10 одинаковых строк. Почему одинаковых? Да потому что мы указали какую строку выбрать первой, а как найти следующую нет – вот он и выдает 1-ую строку нужное количество раз. Кстати сказать, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">rownum</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;"> это псевдостолбец, в котором нумеруются строки, начиная от 1 в порядке их выдачи. Его можно использовать не только в иерархических запросах. Но это уже другая история. Как же получить нормальную иерархию? Нужно использовать специальный оператор, который называется </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">PRIOR</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">. Это обычный унарный оператор, точно такой же как + или -. “Позвоните родителям” – говорит он, заставляя Оракл обратиться к предыдущей записи. С его помощью можно написать правило pid = PRIOR id (или PRIOR id = pid, как говорится, от перестановки мест…). Что получается? Оракл находит первую запись, удовлетворяющую условию в START WITH, и принимается искать следующую. При этом к той первой записи можно обратиться через PRIOR. Если мы все сделали правильно, то Оракл будет искать записи, в которых в поле для хранения информации о родителе (pid) будет содержаться значение, равное идентификатору id нашей первой записи. Таким образом будут найдены все потомки корневой записи. А так как процесс рекурсивный, аналогичный поиск будет продолжаться с каждой найденной строкой, пока не отыщутся все потомки.  Теперь у нас есть все необходимое, чтобы написать иерархический запрос в Oracle. Но прежде чем мы его напишем, расскажу еще об одной штуке. Порядок строк это хорошо, но нам было бы трудно понять, две строки рядом это родитель и его потомок или два брата-потомка одного родителя. Пришлось бы сверять id и pid. К счастью, Oracle предлагает в помощь дополнительный псевдостолбец </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">LEVEL</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">. Как легко догадаться, в нем записывается уровень записи по отношению к корневой. Так, 1-ая запись будет иметь уровень 1, ее потомки уровень 2, потомки потомков — 3 и т.д. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">level</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">, id, pid, title <br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">START</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WITH</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> pid </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">is</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">null</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"><br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">CONNECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">PRIOR</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id = pid;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">LEVEL         ID        PID TITLE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">------ ---------- ---------- -------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     1          1            Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     2          2          1 Воронеж</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     3          3          2 ООО &quot;Рога и копыта&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     4          6          3 Главный офис</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     4          7          3 Офис 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     4          8          3 Офис 2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     5          9          8 Сервер 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     2          4          1 Москва</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     2          5          1 Лиски</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     3         10          5 ЛискиПресс</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">Неплохо. Все дочерние строки оказываются под своими родителями. Сортировку бы еще добавить, чтобы записи одного уровня выводились не абы-как, а по алфавиту. Ну чтож, сортировка это просто: добавим в конец запроса конструкцию ORDER BY title. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">level</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">, id, pid, title <br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">START</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WITH</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> pid </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">is</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">null</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"><br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">CONNECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">PRIOR</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id = pid<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">ORDER</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> title;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">LEVEL         ID        PID TITLE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">------ ---------- ---------- -------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     2          2          1 Воронеж</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     4          6          3 Главный офис</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     2          5          1 Лиски</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     3         10          5 ЛискиПресс</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     2          4          1 Москва</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     3          3          2 ООО &quot;Рога и копыта&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     4          7          3 Офис 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     4          8          3 Офис 2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     1          1            Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">     5          9          8 Сервер 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">О, нет! Вся иерархия поломалась. Что же получилось? Оракл честно выбрал нужные строки в порядке иерархии (об этом говорит правильная расстановка level), а затем пересортировал их согласно правилу ORDER BY. Чтобы указать Ораклу, что сортировать надо только в пределах одного уровня иерархии, нам поможет маленькая добавка в виде оператора </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">SIBLINGS</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">. Достаточно изменить условие сортировки на ORDER SIBLINGS BY title – и все встанет на свои места. Кстати, возможно все еще не понятно, почему этот порядок строк является деревом. Можно убрать все “лишние” поля и добавить отступы, станет более наглядно: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> lpad(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a31515;">' '</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">, 3*</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">level</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">)||title </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> Tree<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">START</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WITH</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> pid </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">is</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">null</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"><br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">CONNECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">PRIOR</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id = pid<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">ORDER</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> SIBLINGS </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> title;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">TREE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">-----------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">   Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">      Воронеж</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">         ООО &quot;Рога и копыта&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">            Главный офис</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">            Офис 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">            Офис 2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">               Сервер 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">      Лиски</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">         ЛискиПресс</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">      Москва</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">Ну вот, теперь все в точности, как на картинке в самом начале статьи. Помните, файловые менеджеры обычно пишут путь к каталогу, в котором вы находитесь: /home/maovrn/documents/ и т.п.? Неплохо было бы и нам сделать так же. А сделать это можно абсолютно не напрягаясь: специалисты из Oracle все уже сделали за нас. Просто берем и используем функцию </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">SYS_CONNECT_BY_PATH()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">. Она принимает два параметра через запятую: название колонки и строку с символом-разделителем. Будем не оригинальны, напишем так: SYS_CONNECT_BY_PATH(title, ‘/’). Заодно ограничим вывод, выбрав только одну строку. Для этого, как всегда, нужно добавить условие WHERE. Даже в иерархическом запросе ограничивающее условие применяется ко всем строкам. Вставить его надо до иерархической конструкции, сразу после FROM. Для примера определим путь до “Сервер 1”, который у нас записан с id=9: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> SYS_CONNECT_BY_PATH(title, </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a31515;">'/'</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">) </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">Path</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"><br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WHERE</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id=9<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">START</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WITH</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> pid </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">is</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">null</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"><br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">CONNECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">PRIOR</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id = pid;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">PATH</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">----------------------------------------------------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">/Россия/Воронеж/ООО &quot;Рога и копыта&quot;/Офис 2/Сервер 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">Еще может быть полезен псевдостолбец </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">CONNECT_BY_ISLEAF</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">. Его можно использовать так же, как LEVEL. В этом псевдостолбце напротив каждой строки проставляется 0 или 1. Если есть потомки – проставится 0. Если потомков нет, такой узел в дереве называется “листом”, тогда и значение в поле CONNECT_BY_ISLEAF будет равно 1. Устали? Осталось немного, самое страшное уже позади. Раньше мы использовали оператор PRIOR, который ссылался к родительской записи. Помимо него есть другой унарный оператор </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">CONNECT_BY_ROOT</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">, который ссылается (ни за что не догадаетесь!) на корневую запись, т.е. на самую первую в выборке.  </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id, pid, title, </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">level</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">, <br /> CONNECT_BY_ISLEAF </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> IsLeaf, <br /> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">PRIOR</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> title </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> Parent, <br /> CONNECT_BY_ROOT title </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> Root<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">START</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WITH</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> pid </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">is</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">null</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"><br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">CONNECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">PRIOR</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id = pid<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">ORDER</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> SIBLINGS </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> title;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">ID PID TITLE                LEVEL LEAF PARENT               ROOT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">-- --- -------------------- ----- ---- -------------------- ------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">1      Россия               1     0    Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">2  1   Воронеж              2     0    Россия               Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">3  2   ООО &quot;Рога и копыта&quot;  3     0    Воронеж              Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">6  3   Главный офис         4     1    ООО &quot;Рога и копыта&quot;  Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">7  3   Офис 1               4     1    ООО &quot;Рога и копыта&quot;  Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">8  3   Офис 2               4     0    ООО &quot;Рога и копыта&quot;  Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">9  8   Сервер 1             5     1    Офис 2               Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">5  1   Лиски                2     0    Россия               Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">10 5   ЛискиПресс           3     1    Лиски                Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">4  1   Москва               2     1    Россия               Россия</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">Стоит отметить, что если в результате выполнения запроса обнаружится петля, Oracle выдаст ошибку. К счастью, ее можно обойти, хотя если в данных содержатся петли – это явно ошибка, в деревьях не бывает петель. На картинке с “бусами” запроса был нарисован оператор </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">NOCYCLE</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;"> после CONNECT BY – его мы и будем применять. Теперь запрос не будет вылетать. А чтобы определить “больной” участок, воспользуемся псевдостолбцом </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">CONNECT_BY_ISCYCLE</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;"> – в нем во всех хороших строках будет записано 0, а в тех, которые приводят к петлям, волшебным образом окажется 1. Чтобы проиллюстрировать это, придется немного подпортить данные. ЛискиПресс ссылается у нас на город Лиски; изменим запись Лиски, чтобы она ссылалась на ЛискиПресс (не забудьте про commit – я вечно забываю): </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">update</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">set</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> pid=10 </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">where</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id=5;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">Если мы запустим какой-нибудь из предыдущих запросов, увидим, что и Лиски, и ЛискиПресс выпали из выборки, будто их нет совсем. Бегая в цикле, Оракл просто перестал на них натыкаться, т.к. нет пути от записи Россия к городу Лиски. Изменим условия START WITH, чтобы начинать с города Лиски – появится ошибка. Умный Оракл видит что запись уже выбиралась ранее и отказывается бегать в бесконечном цикле. Исправляем ошибку: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> CONNECT_BY_ISCYCLE </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> cycl, id, pid, title <br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">START</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WITH</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id=5<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">CONNECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> NOCYCLE </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">PRIOR</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id = pid;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">CYCL         ID        PID TITLE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">---- ---------- ---------- ----------</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">   0          5         10 Лиски</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">   1         10          5 ЛискиПресс</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:28px; background-color:#ffffff;"><span style=" font-family:'Fira Sans,sans-serif'; font-size:8.25pt; font-weight:496; color:#222222; background-color:#ffffff;">Практические примеры</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">Иерархические запросы можно применять не только там, где есть явная иерархия. Например, рассмотрим задачу </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-style:italic; color:#222222; background-color:#ffffff;">получения списка пропущенных номеров из последовательности</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">. Это бывает нужно, когда в некоей таблице id генерируется автоматически путем увеличения на 1, но часть записей были удалены. Нужно получить список удаленных номеров. По хорошей традиции, это следует сделать одним селектом. Подготовим тестовые данные. Удалим из нашей таблицы пару записей: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">DELETE</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WHERE</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">IN</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> (3, 5);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">С чего начнем? Во-первых, неплохо было бы получить список номеров подряд от 1 до максимального значения в нашей таблице, чтобы было с чем сравнивать. Выяснить максимальное значение id из таблицы, думаю, не составит никаких трудностей: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">max</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">(id) </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">А вот чтобы сгенерировать последовательность от 1 до max как раз и понадобится рекурсивный запрос. Ведь как здорово просто взять и получить нужное количество строк! Достаточно будет их пронумеровать – и вот список готов. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> rownum </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> rn </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> dual<br /> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">CONNECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">level</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> &lt;= (</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">max</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">(id) </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">Конструкция “SELECT … FROM dual” используется, когда надо вычислить значение функции, не производя при этом выборки данных. </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">Dual</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;"> – это системная таблица, состоящая из одного столбца и одной строки. Запрос из нее всегда возвращает одну строку со значением ‘X’. Благодаря такой умопомрачительной стабильности, эту таблицу удобно использовать в качестве источника строк. Обычно таблицу, которую нагло используют для получения нужного количества строк, не выбирая сами данные, называют </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222; background-color:#ffffff;">pivot</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222; background-color:#ffffff;">. В качестве такой таблицы может выступать любая большая таблица, в том числе системная. Но использование dual в Oracle является более разумным решением. Теперь, когда список номеров подряд уже есть, достаточно пройтись по нему и сравнить, есть ли такой номер в проверяемой таблице: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> sq.rn <br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> (</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> rownum </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> rn </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> dual<br /> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">CONNECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">level</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> &lt;= (</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">max</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;">(id) </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table)) sq<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">WHERE</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> sq.rn </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">not</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">in</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> (</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">SELECT</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> id </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">FROM</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> test_table)<br /></span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">ORDER</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#0000ff;">BY</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#000000;"> rn;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">  RN</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">----</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">   3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'monospace,monospace'; font-size:8.25pt; color:#222222; background-color:#ffffff;">   5</span></p></body></html>