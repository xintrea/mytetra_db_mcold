<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:11px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Fira Sans,sans-serif'; font-size:8.25pt; font-weight:496; color:#343434;">Итерируем все и вся</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#5e6973;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:8px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/hub/python/"><span style=" font-size:13px; text-decoration: underline; color:#0000ff; background-color:transparent;">Python</span></a></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:16px; color:#6a1009;"> <br />Насколько я успел понять по собственному опыту, при переходе на Python с другого языка программирования порой сложно привыкнуть к его специфическому подходу к циклам. Например, взять тот же самый for, который работает совершенно по-другому, нежели в других языках. Возьму на себя смелость рассказать о том, что мне самому поначалу было сложно осознать, а тем более использовать в своем коде — итераторы. Вещь на самом деле очень полезная, надо только уметь правильно ей пользоваться! ;)<br /><br />АПД: Только сейчас заметил, что тема функционального программирования сегодня популярна как никогда :) Спасибо товарищу uj2 за раскрытие такой интересной темы, поддерживаю!<br /><br />Итераторы — это специальные объекты, представляющие последовательный доступ к данным из контейнера. При этом немаловажную роль играет то, что память фактически не тратится, так как промежуточные данные выдаются по мере необходимости при запросе, поэтому фактически в памяти останутся только исходные данные и конечный результат, да и их можно читать и записывать, используя файл на диске.<br /><br />Итератор удобно использовать вместе с последовательностью. Любой объект, поддерживающий интерфейс итератора, имеет метод next(), позволяющий переходить на следующую ступень вычисления. Чтобы получить итератор по объекту (например, по списку), к нему нужно применить функцию iter(). Кстати, уже упомянутый цикл for тоже задействует итератор, только без дополнительных танцев — все делается автоматически. Для обработки сложных наборов данных можно подключить стандартный модуль itertools.<br /><br />Создадим простейший итератор вручную:<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; font-size:16px; color:#6a1009;">testIt = iter([1, 2, 3, 4, 5]) <br />print [x for x in testIt]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Конечно, это простейшее использование цикла </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">for</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">, только записанное немного по-другому.<br />«И что же тут нового?» — спросите вы. Да, в принципе, ничего, просто немного залезли глубже в структуру обработки последовательностей. Но теперь, как вам такое: функция </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">iter()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"> может принимать не только структуру данных, которая так запросто представляет свой итератор, но и два совсем других аргумента: функцию без аргументов и стоповое значение, на котором итерация остановится. Пример:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#222222;">def getSimple(state=[]): <br />  if len(state) &lt; 4: <br />    state.append(&quot; &quot;) <br />    return &quot; &quot;<br /><br />testIt2 = iter(getSimple, None) <br />print [x for x in testIt2]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Пример основан на том, что в Python при отсутствии явного возвращения значения из функции возвращается значение </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">None</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">. <br /><br />Теперь рассмотрим несколько функций, работа которых основана на итераторах:<br /><br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">enumerate()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Предназначена для нумерации элементов структуры данных (в том числе и другого итератора). Возвращает список кортежей, в каждом из которых первый элемент — номер (начиная с нуля), а второй — элемент исходного итератора. Пример:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#222222;">&gt;&gt;&gt; print [x for x in enumerate(&quot;abcd&quot;)] <br />[(0, 'a'), (1, 'b'), (2, 'c'), (3, 'd')]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">sorted()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Итератор, выполняющий сортировку:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#222222;">&gt;&gt;&gt; sorted('avdsdf') <br />['a', 'd', 'd', 'f', 's', 'v']</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.chain()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Итератор, позволяющий объединить два разных итератора в один. Пример:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#222222;">from itertools import chain <br />it1 = iter([1,2,3]) <br />it2 = iter([8,9,0]) <br />for i in chain(it1, it2): <br />  print i,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />даст в результате «1 2 3 8 9 0».<br /><br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.count()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Итератор, выдающий бесконечные числа, начиная с заданного:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#222222;">for i in itertools.count(1): <br />  print i, <br />  if i &gt; 100: <br />    break</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Результат:<br />1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 <br />27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 <br />50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 <br />73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 <br />96 97 98 99 100 101<br /><br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.cycle()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Бесконечно повторяет заданную последовательность:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#222222;">tango = [1, 2, 3] <br />for i in itertools.cycle(tango): <br />  print i,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Результат:<br />1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1.. <br /><br />Так же в этом модуле есть аналоги </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">map()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">starmap()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">filter()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"> и </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">zip()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">, называются они, естественно, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.imap()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.starmap()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.ifilter()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"> и </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.izip()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">. Их преимущество в том, что, в отличие от своих «обычных» аналогов тратят гораздо меньше памяти. Существует также пара фильтров: </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.takewhile()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"> и </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">itertools.dropwhile()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;">:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#222222;">for i in takewhile(lambda x: x &gt; 0, [1, -2, 3, -3]): <br />  print i, <br />for i in dropwhile(lambda x: x &gt; 0, [1, -2, 3, -3]): <br />  print i,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Результат:<br />1 <br />-2 3 -3<br /><br />Дело в том, что </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">takewhile()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"> возвращает значения, пока условие истинно, а остальные значения даже не берет из итератора (именно не берет, а не высасывает все до конца!). И, наоборот, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#222222;">dropwhile()</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"> ничего не выдает, пока выполняется условие, зато потом выдает все без остатка.<br /><br />Ну и, напоследок, давайте все-таки напишем свой собственный итератор (чуть было не дописал известную фразу Бендера)!<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#222222;">class Fibonacci: <br />&quot;&quot;&quot;Итератор последовательности Фибоначчи до N&quot;&quot;&quot; <br />  def __init__(self, N): <br />    self.n, self.a, self.b, self.max = 0, 0, 1, N <br />  def __iter__(self): <br />    # сами себе итератор: в классе есть метод next() <br />     return self <br />  def next(self): <br />     if self.n &lt; self.max: <br />       a, self.n, self.a, self.b = self.a, self.n+1, self.b, self.a+self.b <br />       return a <br />     else: <br />       raise StopIteration <br /># Использование: <br />for i in Fibonacci(100): <br />  print i,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:8.25pt; color:#222222;"><br />Вот, собственно и вся основная теория. Если хотите узнать побольше тонкостей — читайте специальную литературу. Если есть какие-то замечания — буду рад выслушать :)<br /><br />В статье использованы материалы лекции Романа Арвиевича Сузи «Элементы функционального программирования».</span></p></body></html>