<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#000000;"><br />Циклы. Цикл for-in.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Оператор for-in предназначен для поочередного обращения к значениям перечисленным в списке. Каждое значение поочередно в списке присваивается переменной. Синтаксис следующий: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">for переменная in список_значений<br />do<br />команды<br />done<br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Рассмотрим небольшой пример: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">#!/bin/bash<br />for i in 0 1 2 3 4 #переменной $i будем поочередно присваивать значения от 0 до 4 включительно<br />do<br />echo &quot;Console number is $i&quot; &gt;&gt; /dev/pts/$i #Пишем в файл /dev/pts/$i(файл виртуального терминала) строку &quot;Console number is $i&quot;<br />done #цикл окончен<br />exit 0<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">После выполнения примера в первых 5 виртуальных консолях(терминалах) появится строка с её номером. В переменную $i поочередно подставляются значения из списка и в цикле идет работа со значением этой переменной </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#000000; background-color:#ffffff;">Циклы. Цикл while.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Цикл while сложнее цикла for-in и используется для повторения команд, пока какое-то выражение истинно( код возврата = 0). Синтаксис оператора следующий: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">while выражение или команда возвращающая код возврата<br />do<br />команды<br />done<br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Пример работы цикла рассмотрим на следующем примере: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">#!/bin/bash<br />again=yes #присваиваем значение &quot;yes&quot; переменной again<br />while [ &quot;$again&quot; = &quot;yes&quot; ] #Будем выполнять цикл, пока $again будет равно &quot;yes&quot;<br />do<br />echo &quot;Please enter a name:&quot;<br />read name<br />echo &quot;The name you entered is $name&quot;<br /><br />echo &quot;Do you wish to continue?&quot;<br />read again<br />done<br />echo &quot;Bye-Bye&quot;<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">А теперь результат работы скрипта: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">ite@ite-desktop:~$ ./bash2_primer1.sh<br />Please enter a name:<br />ite<br />The name you entered is ite<br />Do you wish to continue?<br />yes<br />Please enter a name:<br />mihail<br />The name you entered is mihail<br />Do you wish to continue?<br />no<br />Bye-Bye<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Как видим цикл выполняется до тех пор, пока мы не введем что-то отличное от «yes». Между do и done можно описывать любые структуры, операторы и т.п., все они будут выполнятся в цикле.Но следует быть осторожным с этим циклом, если вы запустите на выполнение в нём какую-либо команду, без изменения переменной выражения, вы можете попасть в бесконечный цикл. Теперь об условии истинности. После while, как и в условном операторе if-then-else можно вставлять любое выражение или команду, которая возвращает код возврата, и цикл будет исполнятся до тех пор, пока код возврата = 0! Оператор &quot;[&quot; аналог команды test, которая проверяет истинность условия, которое ей передали. Рассмотрим еще один пример, я взял его из книги Advanced Bash Scripting. Уж очень он мне понравился :), но я его немного упростил. </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; font-weight:696; color:#000000; background-color:#ffffff;">В этом примере мы познакомимся с еще одним типом циклов UNTIL-DO</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">. Эта практически полный аналог цикла WHILE-DO, только выполняется пока какое-то выражение ложно. Вот пример: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">#!/bin/bash<br />echo &quot;Введите числитель: &quot;<br />read dividend<br />echo &quot;Введите знаменатель: &quot;<br />read divisor<br /><br />dnd=$dividend #мы будем изменять переменные dividend и divisor,<br />#сохраним их знания в других переменных, т.к. они нам<br />#понадобятся<br />dvs=$divisor<br />remainder=1<br /><br />until [ &quot;$remainder&quot; -eq 0 ]<br />do<br />let &quot;remainder = dividend % divisor&quot;<br />dividend=$divisor <br />divisor=$remainder<br />done <br /><br />echo &quot;НОД чисел $dnd и $dvs = $dividend&quot; <br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Результат выполнения скрипта: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">ite@ite-desktop:~$ ./bash2_primer3.sh<br />Введите числитель:<br />100<br />Введите знаменатель:<br />90<br />НОД чисел 100 и 90 = 10<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#000000; background-color:#ffffff;">Математические операции</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Команда let. Команда let производит арифметические операции над числами и переменными. Рассмотрим небольшой пример, в котором мы производим некоторые вычисления над введенными числами: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">#!/bin/bash<br />echo &quot;Введите a: &quot;<br />read a<br />echo &quot;Введите b: &quot;<br />read b<br /><br />let &quot;c = a + b&quot; #сложение<br />echo &quot;a+b= $c&quot;<br />let &quot;c = a / b&quot; #деление<br />echo &quot;a/b= $c&quot;<br />let &quot;c &lt;&lt;= 2&quot; #сдвигает c на 2 разряда влево<br />echo &quot;c после сдвига на 2 разряда: $c&quot;<br />let &quot;c = a % b&quot; # находит остаток от деления a на b<br />echo &quot;$a / $b. остаток: $c &quot;<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Результат выполнения: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">ite@ite-desktop:~$ ./bash2_primer2.sh<br />Введите a:<br />123<br />Введите b:<br />12<br />a+b= 135<br />a/b= 10<br />c после сдвига на 2 разряда: 40<br />123 / 12. остаток: 3<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Ну вот, как видите ничего сложного, список математических операций стандартный: + — сложение — — вычитание * — умножение / — деление ** — возведение в степень % — модуль(деление по модулю), остаток от деления let позволяет использовать сокращения арифметических команд, тем самым сокращая кол-во используемых переменных. Например: a = a+b эквивалентно a +=b и т.д </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:large; color:#000000; background-color:#ffffff;">Работа с внешними программами при написании shell-скриптов</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Для начала немного полезной теории. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:small; color:#000000; background-color:#ffffff;">Перенаправление потоков.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">В bash(как и многих других оболочках) есть встроенные файловые дескрипторы: 0 (stdin), 1 (stdout), 2 (stderr). stdout — Стандартный вывод. Сюда попадает все что выводят программы stdin — Стандартный ввод. Это все что набирает юзер в консоли stderr — Стандартный вывод ошибок.  Для операций с этими дескрипторами, существуют специальные символы: &gt; (перенаправление вывода), &lt; (перенаправление ввода). Оперировать ими не сложно. Например: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">cat /dev/random &gt; /dev/null</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">перенаправить вывод команды cat /dev/random в /dev/null (абсолютно бесполезная операция :)) ) или </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">ls -la &gt; listing</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">записать в файл listing содержание текущего каталога (уже полезней) Если есть необходимость дописывать в файл(при использовании &quot;&gt;&quot; он заменятеся), необходимо вместо &quot;&gt;&quot; использовать &quot;&gt;&gt;&quot; </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">sudo &lt; my_password</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">после просьбы sudo ввести пароль, он возьмется из файла my_password, как будто вы его ввели с клавиатуры. Если необходимо записать в файл только ошибки, которые могли возникнуть при работе программы, то можно использовать: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">./program_with_error 2&gt; error_file</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">цифра 2 перед &quot;&gt;&quot; означает что нужно перенаправлять все что попадет в дескриптор 2(stderr). Если необходимо заставить stderr писать в stdout, то это можно можно след. образом: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">./program_with_error 2&gt;&amp;1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">символ &quot;&amp;&quot; означает указатель на дескриптор 1(stdout) (Поумолчанию stderr пишет на ту консоль, в котрой работает пользователь(вренее пишет на дисплей)). </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:small; color:#000000; background-color:#ffffff;">2.Конвееры.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Конвеер — очень мощный инструмент для работы с консолью Bash. Синтаксис простой: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">команда1 | команда 2 </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">— означает, что вывод команды 1 передастся на ввод команде 2 Конвееры можно группировать в цепочки и выводить с помощью перенаправления в файл, например: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">ls -la | grep «hash» |sort &gt; sortilg_list</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">вывод команды ls -la передается команде grep, которая отбирает все строки, в которых встретится слово hash, и передает команде сортировке sort, которая пишет результат в файл sorting_list. Все довольно понятно и просто. Чаще всего скрипты на Bash используются в качестве автоматизации каких-то рутинных операций в консоли, отсюда иногда возникает необходимость в обработке stdout одной команды и передача на stdin другой команде, при этом результат выполнения одной команды должен быть неким образом обработан. В этом разделе я постораюсь объяснить основные принципы работы с внешними командами внутри скрипта. Думаю что примеров я привел достаточно и можно теперь писать только основные моменты. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:small; color:#000000; background-color:#ffffff;">1. Передача вывода в переменную.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Для того чтобы записать в переменную вывод какой-либо команды, достаточно заключить команду в `` ковычки, например </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">a = `echo &quot;qwerty&quot;`<br />echo $a<br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br />Результат работы: qwerty</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Однако если вы захотите записать в переменную список директорий, то необходимо, должным образом обработать результат для помещения данных в переменную. Рассмотрим небольшой, пример: </span></p>
<p style=" margin-top:14px; margin-bottom:14px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222;">LIST=`find /svn/ -type d 2&gt;/dev/null| awk '{FS=&quot;/&quot;} {print $4}'| sort|uniq | tr '\n' ' '`<br />for ONE_OF_LIST in $LIST<br />do<br />svnadmin hotcopy /svn/$ONE_OF_LIST /svn/temp4backup/$ONE_OF_LIST<br />done<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Здесь мы используем цикл for-do-done для архивирование всех директорий в папке /svn/ с помощью команды svnadmin hotcopy(что в нашем случае не имеет никого значения, просто как пример). Наибольшй интерес вызывает строка: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">LIST=`find /svn/ -type d 2&gt;/dev/null| awk '{FS=&quot;/&quot;} {print $4}'| sort|uniq | tr '\n' ' '`</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> В ней переменной LIST присваивается выполнение команды find, обработанной командами awk, sort, uniq,tr(все эти команды мы рассматривать не будем, ибо это отдельная статья). В переменной LIST будут имена всех каталогов в папке /svn/ пгомещенных в одну строку(для того чтобы её стравить циклу. Как видно, все не сложно, достаточно понять принцип и написать пару своих скриптов. В заключении статьи хочу пожелать удачи в изучении BASH и Linux в целом. Критика, как водится приветствуется. Следующая статья возможно будет посвещена использованию таких программ как sed, awk. Статьи на </span><a href="http://unix-admin.su/"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#990099; background-color:#ffffff;">unix-admin.su</span></a></p></body></html>