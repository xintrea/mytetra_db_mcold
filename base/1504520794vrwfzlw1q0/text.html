<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><br /></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><img src="image27063.png" /></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:23px; background-color:#ffffff;"><a name="post_text"></a><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;">Э</span><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;">та статья не для матёрых укротителей Python’а, для которых распутать этот клубок змей — детская забава, а скорее поверхностный обзор многопоточных возможностей для недавно подсевших на питон. <br /><br />К сожалению по теме многопоточности в Python не так уж много материала на русском языке, а питонеры, которые ничего не слышали, например, про GIL, мне стали попадаться с завидной регулярностью. В этой статье я постараюсь описать самые основные возможности многопоточного питона, расскажу что же такое GIL и как с ним (или без него) жить и многое другое. <br /></span><a name="habracut"></a><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br /></span><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Python — очаровательный язык программирования. В нем прекрасно сочетается множество парадигм программирования. Большинство задач, с которыми может встретиться программист, решаются здесь легко, элегантно и лаконично. Но для всех этих задач зачастую достаточно однопоточного решения, а однопоточные программы обычно предсказуемы и легко поддаются отладке. Чего не скажешь о многопоточных и многопроцессных программах.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; font-weight:696; color:#000000;">Многопоточные приложения</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />В Python есть модуль </span><a href="http://docs.python.org/library/threading.html"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; text-decoration: underline; color:#bd6fda;">threading</span></a><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;">, и в нем есть все, что нужно для многопоточного программирования: тут есть и различного вида локи, и семафор, и механизм событий. Один словом — все, что нужно для подавляющего большинства многопоточных программ. Причем пользоваться всем этим инструментарием достаточно просто. Рассмотрим пример программы, которая запускает 2 потока. Один поток пишет десять “0”, другой — десять “1”, причем </span><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; font-weight:600; color:#000000;">строго</span><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"> по-очереди.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">import</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> threading</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">def</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#4078f2; background-color:#f0f0f0;">writer</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">(x, event_for_wait, event_for_set):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">    </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">for</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> i </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">in</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> xrange(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">10</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        event_for_wait.wait() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># wait for event</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        event_for_wait.clear() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># clean event for future</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">print</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> x</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        event_for_set.set() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># set event for neighbor thread</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># init events</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">e1 = threading.Event()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">e2 = threading.Event()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># init threads</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1 = threading.Thread(target=writer, args=(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">0</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">, e1, e2))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2 = threading.Thread(target=writer, args=(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">1</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">, e2, e1))</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># start threads</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1.start()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2.start()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">e1.set() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># initiate the first event</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># join threads to the main thread</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1.join()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2.join()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Никакой магии и voodoo-кода. Код четкий и последовательный. Причем, как можно заметить, мы создали поток из функции. Для небольших задач это очень удобно. Этот код еще и достаточно гибкий. Допустим у нас появился 3-й процесс, который пишет “2”, тогда код будет выглядеть так:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">import</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> threading</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">def</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#4078f2; background-color:#f0f0f0;">writer</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">(x, event_for_wait, event_for_set):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">    </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">for</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> i </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">in</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> xrange(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">10</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        event_for_wait.wait() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># wait for event</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        event_for_wait.clear() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># clean event for future</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">print</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> x</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        event_for_set.set() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># set event for neighbor thread</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># init events</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">e1 = threading.Event()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">e2 = threading.Event()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">e3 = threading.Event()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># init threads</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1 = threading.Thread(target=writer, args=(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">0</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">, e1, e2))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2 = threading.Thread(target=writer, args=(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">1</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">, e2, e3))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t3 = threading.Thread(target=writer, args=(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">2</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">, e3, e1))</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># start threads</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1.start()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2.start()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t3.start()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">e1.set() </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># initiate the first event</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; font-style:italic; color:#a0a1a7; background-color:#f0f0f0;"># join threads to the main thread</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1.join()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2.join()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t3.join()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Мы добавили новое событие, новый поток и слегка изменили параметры, с которыми<br />стартуют потоки (можно конечно написать и более общее решение с использованием, например, MapReduce, но это уже выходит за рамки этой статьи).<br />Как видим по-прежнему никакой магии. Все просто и понятно. Поехали дальше.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; font-weight:696; color:#000000;">Global Interpreter Lock</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Существуют две самые распространенные причины использовать потоки: во-первых, для увеличения эффективности использования многоядерной архитектуры cоврменных процессоров, а значит, и производительности программы;<br />во-вторых, если нам нужно разделить логику работы программы на параллельные полностью или частично асинхронные секции (например, иметь возможность пинговать несколько серверов одновременно).<br /><br />В первом случае мы сталкиваемся с таким ограничением Python (а точнее основной его реализации CPython), как Global Interpreter Lock (или сокращенно GIL). Концепция GIL заключается в том, что в каждый момент времени только один поток может исполняться процессором. Это сделано для того, чтобы между потоками не было борьбы за отдельные переменные. Исполняемый поток получает доступ по всему окружению. Такая особенность реализации потоков в Python значительно упрощает работу с потоками и дает определенную потокобезопасность (thread safety).<br /><br />Но тут есть тонкий момент: может показаться, что многопоточное приложение будет работать ровно столько же времени, сколько и однопоточное, делающее то же самое, или за сумму времени исполнения каждого потока на CPU. Но тут нас поджидает один неприятный эффект. Рассмотрим программу:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">with</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> open(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#50a14f; background-color:#f0f0f0;">'test1.txt'</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">, </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#50a14f; background-color:#f0f0f0;">'w'</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">) </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> fout:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">    </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">for</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> i </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">in</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> xrange(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">1000000</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">print</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> &gt;&gt; fout, </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">1</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Эта программа просто пишет в файл миллион строк “1” и делает это за ~0.35 секунды на моем компьютере.<br /><br />Рассмотрим другую программу:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">from</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> threading </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">import</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> Thread</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">def</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#4078f2; background-color:#f0f0f0;">writer</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">(filename, n):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">    </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">with</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> open(filename, </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#50a14f; background-color:#f0f0f0;">'w'</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">) </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">as</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> fout:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">        </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">for</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> i </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">in</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> xrange(n):</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">            </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">print</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> &gt;&gt; fout, </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">1</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1 = Thread(target=writer, args=(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#50a14f; background-color:#f0f0f0;">'test2.txt'</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">, </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">500000</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">,))</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2 = Thread(target=writer, args=(</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#50a14f; background-color:#f0f0f0;">'test3.txt'</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">, </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#986801; background-color:#f0f0f0;">500000</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">,))</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1.start()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2.start()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t1.join()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">t2.join()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Эта программа создает 2 потока. В каждом потоке она пишет в отдельный файлик по пол миллиона строк “1”. По-сути объем работы такой же, как и у предыдущей программы. А вот со временем работы тут получается интересный эффект. Программа может работать от 0.7 секунды до аж 7 секунд. Почему же так происходит?<br /><br />Это происходит из-за того, что когда поток не нуждается в ресурсе CPU — он освобождает GIL, а в этот момент его может попытаться получить и он сам, и другой поток, и еще и главный поток. При этом операционная система, зная, что ядер много, может усугубить все попыткой распределить потоки между ядрами.<br /><br />UPD: на данный момент в Python 3.2 существует улучшенная реализация GIL, в которой эта проблема частично решается, в частности, за счет того, что каждый поток после потери управления ждет небольшой промежуток времени до того, как сможет опять захватить GIL (на эту тему есть хорошая </span><a href="http://www.dabeaz.com/python/NewGIL.pdf"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; text-decoration: underline; color:#bd6fda;">презентация</span></a><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"> на английском)<br /><br />«Выходит на Python нельзя писать эффективные многопоточные программы?», — спросите вы. Нет, конечно, выход есть и даже несколько.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; font-weight:696; color:#000000;">Многопроцессные приложения</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Для того, чтобы в некотором смысле решить проблему, описанную в предыдущем параграфе, в Python есть модуль </span><a href="http://docs.python.org/library/subprocess.html"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; text-decoration: underline; color:#bd6fda;">subprocess</span></a><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;">. Мы можем написать программу, которую хотим исполнять в параллельном потоке (на самом деле уже процессе). И запускать ее в одном или нескольких потоках в другой программе. Такой способ действительно ускорил бы работу нашей программы, потому, что потоки, созданные в запускающей программе GIL не забирают, а только ждут завершения запущенного процесса. Однако, в этом способе есть масса проблем. Основная проблема заключается в том, что передавать данные между процессами становится трудно. Пришлось бы как-то сериализовать объекты, налаживать связь через PIPE или друге инструменты, а ведь все это несет неизбежно накладные расходы и код становится сложным для понимания.<br /><br />Здесь нам может помочь другой подход. В Python есть модуль </span><a href="http://docs.python.org/library/multiprocessing.html"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; text-decoration: underline; color:#bd6fda;">multiprocessing</span></a><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;">. По функциональности этот модуль напоминает </span><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; font-weight:600; color:#000000;">threading</span><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;">. Например, процессы можно создавать точно так же из обычных функций. Методы работы с процессами почти все те же самые, что и для потоков из модуля threading. А вот для синхронизации процессов и обмена данными принято использовать другие инструменты. Речь идет об очередях (Queue) и каналах (Pipe). Впрочем, аналоги локов, событий и семафоров, которые были в threading, здесь тоже есть.<br /><br />Кроме того в модуле multiprocessing есть механизм работы с общей памятью. Для этого в модуле есть классы переменной (Value) и массива (Array), которые можно “обобщать” (share) между процессами. Для удобства работы с общими переменными можно использовать классы-менеджеры (Manager). Они более гибкие и удобные в обращении, однако более медленные. Нельзя не отметить приятную возможность делать общими типы из модуля ctypes с помощью модуля multiprocessing.sharedctypes.<br /><br />Еще в модуле multiprocessing есть механизм создания пулов процессов. Этот механизм очень удобно использовать для реализации шаблона Master-Worker или для реализации параллельного Map (который в некотором смысле является частным случаем Master-Worker).<br /><br />Из основных проблем работы с модулем multiprocessing стоит отметить относительную платформозависимость этого модуля. Поскольку в разных ОС работа с процессами организована по-разному, то на код накладываются некоторые ограничения. Например, в ОС Windows нет механизма fork, поэтому точку разделения процессов надо оборачивать в:<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#a626a4; background-color:#f0f0f0;">if</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;"> __name__ ==</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#50a14f; background-color:#f0f0f0;">'__main__'</span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42; background-color:#f0f0f0;">:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Menlo,Monaco,Courier New,monospace'; font-size:8.25pt; color:#383a42;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Впрочем, эта конструкция и так является хорошим тоном.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:20px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; font-weight:696; color:#000000;">Что еще ...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"><br />Для написания параллельных приложений на Python существуют и другие библиотеки и подходы. Например, можно использовать Hadoop+Python или различные реализации MPI на Python (pyMPI, mpi4py). Можно даже использовать обертки существующих библиотек на С++ или Fortran. Здесь можно было упомянуть про такие фреймфорки/библиотеки, как Pyro, Twisted, Tornado и многие другие. Но это все уже выходит за пределы этой статьи.<br /><br />Если мой стиль вам понравился, то в следующей статье постараюсь рассказать, как писать простые интерпретаторы на </span><a href="http://www.dabeaz.com/ply/"><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; text-decoration: underline; color:#bd6fda;">PLY</span></a><span style=" font-family:'Helvetica,verdana,arial,tahoma,sans-serif'; font-size:8.25pt; color:#000000;"> и для чего их можно применять.</span></p></body></html>