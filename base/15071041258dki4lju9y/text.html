<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:11px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Fira Sans,sans-serif'; font-size:xx-large; font-weight:496; color:#343434;">Рекурсивные SQL запросы</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:13px; color:#5e6973;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:8px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/hub/sql/"><span style=" font-size:13px; text-decoration: underline; color:#0000ff; background-color:transparent;">SQL</span></a></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" background-color:#ffffff;">Рекурсивны SQL запросы являются одним из способов решения проблемы дерева и других проблем, требующих рекурсивную обработку. Они были добавлены в стандарт SQL 99. До этого они уже существовали в Oracle. Несмотря на то, что стандарт вышел так давно, реализации запоздали. Например, в MS SQL они появились только в 2005-ом сервере.<br /><br />Рекурсивные запросы используют довольно редко, прежде всего, из-за их сложного и непонятного синтаксиса: <br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009; background-color:#ffffff;">with [recursive] &lt;имя_алиаса_запроса&gt; [ (&lt;список столбцов&gt;) ]<br />as (&lt;запрос&gt;) <br />&lt;основной запрос&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#222222;"><br />В MS SQL нет ключевого слова recursive, а в остальном все тоже самое. Такой синтаксис поддерживается в DB2, Sybase iAnywhere, MS SQL и во всех базах данных, которые поддерживают стандарт SQL 99.<br /><br />Проще разобрать на примере. Предположим, есть таблица:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:-5px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">create</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">table</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree_sample (<br />  id </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">integer</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">not</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">null</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">primary</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">key</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;">, <br />  id_parent </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">integer</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">foreign</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">key</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">references</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree_sample (id), <br />  nm </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">varchar</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;">(31) )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#222222;"><br /><br />id – идентификатор<br />id_parent – ссылка на родитель<br />nm – название.<br /><br />Для вывода дерева:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:-5px; -qt-block-indent:0; text-indent:0px; background-color:#fff7d7;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">with</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">recursive</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree (nm, id, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">level</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;">, pathstr)<br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">as</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> (</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">select</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> nm, id, 0, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">cast</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;">(</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#a31515;">''</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">as</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> text) <br />   </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">from</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree_sample<br />   </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">where</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> id_parent </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">is</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">null</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> <br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">union</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">all</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"><br />   </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">select</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree_sample.nm, tree_sample.id, t.</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">level</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> + 1, tree.pathstr + tree_sample.nm<br />   </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">from</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree_sample <br />     </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">inner</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">join</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">on</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree.id = tree_sample.id_parent) <br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">select</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> id, </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">space</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;">( </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">level</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> ) + nm </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">as</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> nm <br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">from</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> tree <br /></span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">order</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> </span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#0000ff;">by</span><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#000000;"> pathstr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'-apple-system,BlinkMacSystemFont,Arial,sans-serif'; font-size:16px; color:#222222;"><br /><br />Этот пример выведет дерево по таблице с отступами. Первый запрос из tree_sample этот запрос выдаст все корни дерева. Второй запрос соединяет между собой таблицу tree_sample и tree, которая определяется этим же запросом. Этот запрос дополняет таблицу узлами дерева. <br /><br />Сначала выполняется первый запрос. Потом к его результатам добавляются результаты второго запроса, где данные таблица tree – это результат первого запроса. Затем снова выполняется второй запрос, но данные таблицы tree – это уже результат предыдущего выполнения второго запроса. И так далее. На самом деле база данных работает не совсем так, но результат будет таким же, как результат работы описанного алгоритма.<br /><br />После этого данные этой таблицы можно использовать в основном запросе как обычно.<br /><br />Хочу заметить, что я не говорю о применимости конкретно этого примера, а лишь пишу его для демонстрации возможностей рекурсивных запросов. Этот запрос реально будет работать достаточно медленно из-за order by.</span></p></body></html>