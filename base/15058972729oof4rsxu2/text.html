<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">All of our tables and additional schema definitions are associated with an instance of metadata. Persisting the schema to the database is simply a matter of calling the create_all() method on our metadata instance with the engine where it should cre‐ ate those tables:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#000000; background-color:#ffffff;">metadata.create_all(engine)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">By default, create_all will not attempt to re-create tables that already exist in the database, and it is safe to run multiple times. It’s wiser to use a database migration tool like Alembic to handle any changes to existing tables or additional schema than to try to handcode changes directly in your application code (we’ll explore this more fully in Chapter 11). Now that we have persisted the tables in the database, let’s take a look at Example 1-4, which shows the complete code for the tables we’ve been work‐ ing on in this chapter.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">from </span><span style=" font-family:'Courier New'; color:#000000;">datetime </span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">import </span><span style=" font-family:'Courier New'; color:#000000;">datetime<br /></span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">from </span><span style=" font-family:'Courier New'; color:#000000;">sqlalchemy </span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">import </span><span style=" font-family:'Courier New'; color:#000000;">(MetaData, Table, Column, Integer, Numeric, String, DateTime, ForeignKey, create_engine)<br /><br /><br />metadata = MetaData()<br />cookies = Table(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'cookies'</span><span style=" font-family:'Courier New'; color:#000000;">, metadata,<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'cookie_id'</span><span style=" font-family:'Courier New'; color:#000000;">, Integer(), </span><span style=" font-family:'Courier New'; color:#660099;">primary_key</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">True</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'cookie_name'</span><span style=" font-family:'Courier New'; color:#000000;">, String(</span><span style=" font-family:'Courier New'; color:#0000ff;">50</span><span style=" font-family:'Courier New'; color:#000000;">), </span><span style=" font-family:'Courier New'; color:#660099;">index</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">True</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'cookie_recipe_url'</span><span style=" font-family:'Courier New'; color:#000000;">, String(</span><span style=" font-family:'Courier New'; color:#0000ff;">255</span><span style=" font-family:'Courier New'; color:#000000;">)),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'cookie_sku'</span><span style=" font-family:'Courier New'; color:#000000;">, String(</span><span style=" font-family:'Courier New'; color:#0000ff;">55</span><span style=" font-family:'Courier New'; color:#000000;">)),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'quantity'</span><span style=" font-family:'Courier New'; color:#000000;">, Integer()),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'unit_cost'</span><span style=" font-family:'Courier New'; color:#000000;">, Numeric(</span><span style=" font-family:'Courier New'; color:#0000ff;">12</span><span style=" font-family:'Courier New'; color:#000000;">, </span><span style=" font-family:'Courier New'; color:#0000ff;">2</span><span style=" font-family:'Courier New'; color:#000000;">))<br />)<br />users = Table(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'users'</span><span style=" font-family:'Courier New'; color:#000000;">, metadata,<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'user_id'</span><span style=" font-family:'Courier New'; color:#000000;">, Integer(), </span><span style=" font-family:'Courier New'; color:#660099;">primary_key</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">True</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'customer_number'</span><span style=" font-family:'Courier New'; color:#000000;">, Integer(), </span><span style=" font-family:'Courier New'; color:#660099;">autoincrement</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">True</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'username'</span><span style=" font-family:'Courier New'; color:#000000;">, String(</span><span style=" font-family:'Courier New'; color:#0000ff;">15</span><span style=" font-family:'Courier New'; color:#000000;">), </span><span style=" font-family:'Courier New'; color:#660099;">nullable</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">False</span><span style=" font-family:'Courier New'; color:#000000;">, </span><span style=" font-family:'Courier New'; color:#660099;">unique</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">True</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'email_address'</span><span style=" font-family:'Courier New'; color:#000000;">, String(</span><span style=" font-family:'Courier New'; color:#0000ff;">255</span><span style=" font-family:'Courier New'; color:#000000;">), </span><span style=" font-family:'Courier New'; color:#660099;">nullable</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">False</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'phone'</span><span style=" font-family:'Courier New'; color:#000000;">, String(</span><span style=" font-family:'Courier New'; color:#0000ff;">20</span><span style=" font-family:'Courier New'; color:#000000;">), </span><span style=" font-family:'Courier New'; color:#660099;">nullable</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">False</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'password'</span><span style=" font-family:'Courier New'; color:#000000;">, String(</span><span style=" font-family:'Courier New'; color:#0000ff;">25</span><span style=" font-family:'Courier New'; color:#000000;">), </span><span style=" font-family:'Courier New'; color:#660099;">nullable</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">False</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'created_on'</span><span style=" font-family:'Courier New'; color:#000000;">, DateTime(), </span><span style=" font-family:'Courier New'; color:#660099;">default</span><span style=" font-family:'Courier New'; color:#000000;">=datetime.now),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'updated_on'</span><span style=" font-family:'Courier New'; color:#000000;">, DateTime(), </span><span style=" font-family:'Courier New'; color:#660099;">default</span><span style=" font-family:'Courier New'; color:#000000;">=datetime.now, </span><span style=" font-family:'Courier New'; color:#660099;">onupdate</span><span style=" font-family:'Courier New'; color:#000000;">=datetime.now)<br />)<br />orders = Table(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'orders'</span><span style=" font-family:'Courier New'; color:#000000;">, metadata,<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'order_id'</span><span style=" font-family:'Courier New'; color:#000000;">, Integer(), </span><span style=" font-family:'Courier New'; color:#660099;">primary_key</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">True</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'user_id'</span><span style=" font-family:'Courier New'; color:#000000;">, ForeignKey(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'users.user_id'</span><span style=" font-family:'Courier New'; color:#000000;">))<br />)<br />line_items = Table(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'line_items'</span><span style=" font-family:'Courier New'; color:#000000;">, metadata,<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'line_items_id'</span><span style=" font-family:'Courier New'; color:#000000;">, Integer(), </span><span style=" font-family:'Courier New'; color:#660099;">primary_key</span><span style=" font-family:'Courier New'; color:#000000;">=</span><span style=" font-family:'Courier New'; font-weight:600; color:#000080;">True</span><span style=" font-family:'Courier New'; color:#000000;">),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'order_id'</span><span style=" font-family:'Courier New'; color:#000000;">, ForeignKey(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'orders.order_id'</span><span style=" font-family:'Courier New'; color:#000000;">)),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'cookie_id'</span><span style=" font-family:'Courier New'; color:#000000;">, ForeignKey(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'cookies.cookie_id'</span><span style=" font-family:'Courier New'; color:#000000;">)),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'quantity'</span><span style=" font-family:'Courier New'; color:#000000;">, Integer()),<br /> Column(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'extended_cost'</span><span style=" font-family:'Courier New'; color:#000000;">, Numeric(</span><span style=" font-family:'Courier New'; color:#0000ff;">12</span><span style=" font-family:'Courier New'; color:#000000;">, </span><span style=" font-family:'Courier New'; color:#0000ff;">2</span><span style=" font-family:'Courier New'; color:#000000;">))<br />)<br />engine = create_engine(</span><span style=" font-family:'Courier New'; font-weight:600; color:#008080;">'sqlite:///:memory:'</span><span style=" font-family:'Courier New'; color:#000000;">)<br />metadata.create_all(engine)<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">In this chapter, we took a look at how metadata is used as a catalog by SQLAlchemy to store table schemas along with other miscellaneous data. We also can define a table with multiple columns and constraints. We explored the types of constraints and how to explicitly construct them outside of a column object to match an existing schema or naming scheme. Then we covered how to set default values and onupdate values for auditing. Finally, we now know how to persist or save our schema into the database for reuse. The next step is to learn how to work with data within our schema via the SQL Expression Language.</p></body></html>