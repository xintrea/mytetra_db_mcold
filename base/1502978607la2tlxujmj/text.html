<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-weight:600; color:#444444; background-color:#ffffff;">wxPython + py2exe: ошибки по человечески</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:1.4%; background-color:#ffffff;"><img src="image22754.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Предисловие</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Какие бы приложения ни создавались, на разных этапах разработки и поддержки приложений случаются непредвиденные ошибки, которые нужно как-нибудь отлавливать. В этом посте речь пойдет об облагораживании десктопных приложений под windows, созданных с помощью библиотеки </span><a href="http://wxpython.org/"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; text-decoration: underline; color:#5e9a45;">wxPython</span></a><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"> и завернутых в исполняемый файл с помощью </span><a href="http://www.py2exe.org/"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; text-decoration: underline; color:#5e9a45;">py2exe</span></a><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Необходимые знания</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Первое - конструктор wx.App</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Итак, начнем. Первое, что нужно знать, это параметры конструктора класса приложения wx.App. В данном случае интерес представляют аргументы &quot;</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-style:italic; color:#414141;">redirect</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">&quot; и &quot;</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-style:italic; color:#414141;">filename</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">&quot;.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">- </span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-weight:600; color:#414141;">redirect</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"> - отвечает за перенаправление потоков стандартного вывода и потока ошибок. Если значение </span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-style:italic; color:#414141;">True</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"> (а на Windows по умолчанию так и есть), стандартный вывод будет перенаправлен.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">- </span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-weight:600; color:#414141;">filename</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"> - собственно пункт назначения перенаправленного потока (см. </span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-style:italic; color:#414141;">redirect</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">). Если значние не установлено, то есть равно </span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-style:italic; color:#414141;">None </span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">(а на </span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-style:italic; color:#414141;">Windows</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"> по умолчанию так и есть), стандартный вывод будет перенаправлен в стандартное окно (оно, как известно, состоит из текстовой области, в которую сыпятся ошибки и остальной вывод). Окно можно переопределить установив атрибут </span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-style:italic; color:#414141;">outputWindowClass</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"> экземпляра класса приложения (</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; font-style:italic; color:#414141;">wx.App</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Второе - перенаправление потоков вывода</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Управление стандартными потоками вывода можно осуществить через встроенный модуль sys. Доступ к ним можно получить через sys.stdout, sys.stderr. Эти переменные являют собой file-подобные объекты, в которых можно что-то писать.<br /></span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Третье - предупреждения</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Предупреждения (warnings) случаются довольно часто, от DeprecationWarning до массы любых других, как возможные нарушения безопасности и т.д. Это нормальное поведение и придумывать ничего не надо их можно просто отключить.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Собираем все вместе</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">То, что уже было сказано</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Для меня самой удобной схемой работы с ошибками оказалось не перенаправление в файл, а распределения потоков вывода и ошибок в два разные файлы. Таким образом в файл с ошибками будут сыпаться ошибки, а в файл вывода - логи (таким образом удобно хранить и вести некие application-specific журналы и, например, время от времени отправлять статистику разработчику с целью повысить качество работы приложения). Таким образом, в случае возникновения ошибки пользователь увидит только окно с сообщением об ошибке и предложением посмотреть в такой-то файл с описанием ошибки, то есть с логом. Также отключим вывод предупреждений. Выглядит это примерно так:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">import sys<br />import warnings<br />...<br />warnings.simplefilter('ignore')<br />...<br />sys.stdout = open(logs_dir.decode('cp1251') + '\\my_stdout.log'.decode('cp1251'), 'w')<br />sys.stderr = open(logs_dir.decode('cp1251') + '\\my_stderr.log'.decode('cp1251'), 'w')<br />...<br />app = MyApp(redirect=0)<br />...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Смысл декодирования из cp1251 в том, что путь к папке с логами (logs_dir) мы получили откуда-то, а так как ОС у нас Windows, да и живем мы в кириллическом мире, русские названия папок никто не отменял.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Небольшие проблемы с правами</span><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">Так уж исторически сложилось, что в Windows приложения принято устанавливать в папку &quot;Program Files&quot; на логическом диске с системой (в 64-битных версиях Windows есть две таких папки: &quot;Program Files&quot; и &quot;Program Files x86&quot;, думаю, назначение понятно). Проблема в том, что некоторые пользователи системы могут не обладать правами администратора, поэтому логи вести в папке с приложением никак не получится, ибо ограниченный в правах пользователь не сможет писать во что-либо, находящееся в Program Files. Поэтому на помощь приходит домашняя папка пользователя (почему-то на *nix ОС это нормально, а о том, что такое же существует на Windows часто забывают =) ). Получить путь к папке очень просто:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">import os<br />home_dir = os.path.expanduser('~')</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,Utopia,Palatino Linotype,Palatino,serif'; font-size:8.25pt; color:#414141;">В эту папку уже любой пользователь сможет спокойно записывать все, что ему нужно.</span></p></body></html>