<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:5px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:34px; background-color:#ffffff;"><span style=" font-family:'Fira Sans,sans-serif'; font-size:xx-large; font-weight:496; color:#444444;">LVM — это просто!</span></p>
<p style=" margin-top:0px; margin-bottom:16px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/hub/linux/"><span style=" font-family:'Verdana,sans-serif'; font-size:11px; color:#999999; background-color:transparent; vertical-align:middle;">Настройка Linux</span></a><span style=" font-family:'Verdana,sans-serif'; font-size:11px; color:#999999;">*</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:-5px; margin-right:-5px; -qt-block-indent:0; text-indent:0px; line-height:22.4px; background-color:#ffffff;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;">Собственно, хочется просто и доступно рассказать про такую замечательную вещь как Logical Volume Management или Управление Логическими Томами.<br />Поскольку уже давно пользуюсь LVM-ом, расскажу что он значит именно для меня, не подглядывая в мануалы и не выдёргивая цитаты из wiki, своими словами, чтобы было понятно именно тем кто ничего о нем не знает. Постараюсь сразу не рассказывать о всяческих «продвинутых» функциях типа страйпов, снапшотов и т.п.<br /></span><a name="habracut"></a><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br /></span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;">LVM — это дополнительный слой абстракции от железа, позволяющий собрать кучи разнородных дисков в один, и затем снова разбить этот один именно так как нам хочется.<br /><br />есть 3 уровня абстракции:<br />1. PV (Physical Volume) — физические тома (это могут быть разделы или целые «неразбитые» диски)<br />2. VG (Volume Group) — группа томов (объединяем физические тома (PV) в группу, создаём единый диск, который будем дальше разбивать так, как нам хочется)<br />3. LV (Logical Volume) — логические разделы, собственно раздел нашего нового «единого диска» ака Группы Томов, который мы потом форматируем и используем как обычный раздел, обычного жёсткого диска.<br />это пожалуй вся теория. :) теперь практика:<br />для работы нужны пакеты lvm2 и возможность работать с привелегиями root поэтому: <br />$ sudo bash<br /># apt-get install lvm2<br /><br />допустим у нас в компе есть жёсткий диск на 40Гб и нам удалось наскрести немного денег и наконец-то купить себе ТЕРАБАЙТНИК! :))) Система уже стоит и работает, и первый диск разбит одним разделом (/dev/sda1 как / ), второй — самый большой, который мы только подключили — вообще не разбит /dev/sdb…<br />Предлагаю немножко разгрузить корневой диск, а заодно ускорить (новый диск работает быстрее старого) и «обезопасить» систему с помощью lvm.<br />Можно делать на втором диске разделы и добавлять их в группы томов (если нам нужно несколько групп томов),<br />а можно вообще не делать на диске разделы и всё устройство сделать физическим разделом (PV)<br /><br />root@ws:~# pvcreate /dev/sdb<br />Physical volume &quot;/dev/sdb&quot; successfully created<br /><br />Создаём группу томов с говорящим названием, например по имени машины «ws», чтобы когда мы перетащим данный диск на другую машину небыло конфликтов с именами групп томов:<br /><br />root@ws:~# vgcreate ws /dev/sdb<br />Volume group «vg0» successfully created<br /><br />желательно внести с корневого раздела такие папки как /usr /var /tmp /home, чтобы не дефрагментировать лишний раз корневой раздел и ни в коем случае его не переполнить, поэтому создаём разделы:<br /><br />root@ws:~# lvcreate -n usr -L10G ws # здесь мы создаём раздел с именем «usr», размером 10Gb <br />Logical volume «usr» created<br />по аналогии делаем то же для /var, /tmp, /home:<br />root@ws:~# lvcreate -n var -L10G ws<br />root@ws:~# lvcreate -n tmp -L2G ws<br />root@ws:~# lvcreate -n home -L500G ws<br />у нас ещё осталось немного свободного места в группе томов (например для будущего раздела под бэкап)<br />посмотреть сколько именно можно командой:<br />root@ws:~# vgdisplay<br />информацию по созданным логическим томам<br />root@ws:~# lvdisplay<br />информацию по физическим томам<br />root@ws:~# pvdisplay<br /><br />разделы что мы создали появятся в папке /dev/[имя_vg]/, точнее там будут ссылки на файлы, <br />lrwxrwxrwx 1 root root 22 2009-08-10 18:35 swap -&gt; /dev/mapper/ws-swap<br />lrwxrwxrwx 1 root root 21 2009-08-10 18:35 tmp -&gt; /dev/mapper/ws-tmp<br />lrwxrwxrwx 1 root root 21 2009-08-10 18:35 usr -&gt; /dev/mapper/ws-usr<br />lrwxrwxrwx 1 root root 21 2009-08-10 18:35 var -&gt; /dev/mapper/ws-var<br />и т.д…<br /><br />дальше lvm уже почти кончается… форматируем наши разделы в любимые файловые системы:<br />root@ws:~# mkfs.ext2 -L tmp /dev/ws/tmp<br />root@ws:~# mkfs.ext4 -L usr /dev/ws/usr<br />root@ws:~# mkfs.ext4 -L var /dev/ws/var<br />root@ws:~# mkfs.ext4 -L home /dev/ws/home<br /><br />кстати, не плохо было бы сделать раздел подкачки:<br />root@ws:~# lvcreate -n swap -L2G ws<br />root@ws:~# mkswap -L swap /dev/ws/swap<br />root@ws:~# swapon /dev/ws/swap<br /><br />создаём папку и подключая по очереди новообразовавшиеся тома, копируем в них нужное содержимое:<br />root@ws:~# mkdir /mnt/target <br />root@ws:~# mount /dev/ws/home /mnt/target<br />копируем туда всё из папки /home своим любимым файловым менеджером (с сохранением прав доступа), например так ;):<br />root@ws:~# cp -a /home/* /mnt/target/<br />root@ws:~# umount /mnt/target/<br />кстати, для папки temp необходимо только поправить права, копировать туда что-либо необязательно:<br />root@ws:~# mount /dev/ws/tmp /mnt/target &amp;&amp; chmod -R a+rwx /mnt/target &amp;&amp; umount /mnt/target/<br />добавляем нужные строчки в /etc/fstab, например такие:<br />/dev/mapper/ws-home /home ext4 relatime 0 2<br />/dev/mapper/ws-tmp /tmp ext2 noatime 0 2<br />/dev/mapper/ws-swap none swap sw 0 0<br />и перезагружаемся… (продвинутые господа могут обойтись без перезагрузки ;))<br /><br />На вкусное, хочу предложить более продвинутую штуку:<br />допустим у нас есть система с разделом на LVM, а жёсткий диск начал сбоить, тогда мы можем без перезагрузки переместить всю систему на другой жёсткий диск/раздел:<br /><br /># On-line добавление/удаление жёстких дисков с помощью LVM (пример)<br /><br />root@ws:~# pvcreate /dev/sda1 # наш эмулятор сбойного диска <br />Physical volume &quot;/dev/sda1&quot; successfully created<br /><br />root@ws:~# pvcreate /dev/sdb1 # наш эмулятор спасательного диска<br />Physical volume &quot;/dev/sdb1&quot; successfully created<br /><br />root@ws:~# vgcreate vg0 /dev/sda1 # создаю группу томов vg0<br />Volume group «vg0» successfully created<br /><br />root@ws:~# lvcreate -n test -L10G vg0 #создаю раздел для «важной» инфы<br />Logical volume «test» created<br /><br />root@ws:~# mkfs.ext2 /dev/vg0/test # создаю файловую систему на разделе<br />root@ws:~# mount /dev/mapper/vg0-test /mnt/tmp/ #монтирую раздел <br />… # заполняю его информацией, открываю на нем несколько файлов и т.п.<br /><br />root@ws:~# vgextend vg0 /dev/sdb1 # расширяю нашу групу томов на «спасательный» диск<br />Volume group «vg0» successfully extended<br /><br />root@work:~# pvmove /dev/sda1 /dev/sdb1 #передвигаю содержимое с «умирающего» диска на «спасательный»<br />/dev/sda1: Moved: 0.9%<br />/dev/sda1: Moved: 1.8%<br />…<br />/dev/sda1: Moved: 99.7%<br />/dev/sda1: Moved: 100.0%<br /><br />root@work:~# vgreduce vg0 /dev/sda1 # убираю «умирающий» диск из группы томов.<br />Removed &quot;/dev/sda1&quot; from volume group «vg0»<br /><br />Итого:<br />Я создал логический раздел, отформатировал его, примонтировал и заполнил нужными данными, затем переместил его с одного устройства на другое, при этом раздел остался примонтирован и данные всё время оставались доступны!<br />Подобным образом мне удавалось без перезагрузки перенести всю систему с умирающего диска на рэид-массив. :)<br /><br />А это моя любимая ссылка по LVM: </span><a href="http://xgu.ru/wiki/LVM"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#990099; background-color:transparent;">xgu.ru/wiki/LVM</span></a><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000;"><br /><br />P.S. Прошу простить за опечатки, меня постоянно отвлекали =))<br /><br />P.P.S. Ах, да!!! Самое главное и самый большой минус LVM — он не читается grub'ом<br />поэтому раздел /boot должен находиться вне LVM на отдельном разделе жёсткого диска, <br />иначе система не загрузится.</span></p></body></html>